#!/usr/bin/python3

import sys
from common import *

def get_accounts_tfrom(msgs):
    accs = Counter()

    for msg in msgs:
        if isinstance(msg, Transfer):
            accs[msg.acc_from] += 1

    return accs

data, msgs = parse(sys.argv[1])
for msg in msgs:
    print(msg)

all_accs = get_accounts(msgs)
tfrom_accs = get_accounts_tfrom(msgs)
# print(f"all: {all_accs}")
# print(f"tfrom: {tfrom_accs}")
candidates = set(all_accs.items()) & set(tfrom_accs.items())
# single_accs = list(acc for acc, count in all_accs.items() if count == 1)
if len(candidates) > 1:
    raise Exception(f"more than one candidate: {candidates}")
acc_mine = candidates.pop()[0]
# print(f"mine: sacc_mine}")


transaction = next(
    msg for msg in msgs 
    if isinstance(msg, Transfer) and msg.acc_from == acc_mine
)

transaction.acc_to, transaction.acc_from = transaction.acc_from, transaction.acc_to

with open("task4.out", 'wb+') as fil:
    res = b''.join(msg.encode() for msg in msgs)
    fil.write(res)